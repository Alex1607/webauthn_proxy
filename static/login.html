<html>
    <head>
        <meta charset="utf-8">
        <title>WebAuthn Proxy Login</title>
        <link rel="stylesheet" type="text/css" href="/webauthn/static/styles.css"  />
        <script src="/webauthn/static/jquery-3.6.3.min.js"></script>
        <script src="/webauthn/static/script.js"></script>
        <script>
            const registerLinkClick = (defaultUsername) => {
                let uri = "/webauthn/register";
                if (defaultUsername) {
                    uri = uri + `?default_username=${defaultUsername}`;
                }
                window.location.href = uri;
            };

            $(document).ready(() => {
                if (browserCheck()) {
                    $('#username').keyup(function(e) {
                        if ($("#username").is(":focus") && event.key == "Enter") {
                            authenticateUser();
                        }
                    });
                    $('#loginButton').click(authenticateUser);

                    // Prepopulate the username field if specified
                    let queryString = window.location.search;
                    let urlParams = new URLSearchParams(queryString);
                    let username = null;
                    if (urlParams.has('default_username')) {
                        username = urlParams.get('default_username');
                        $('#username').val(username);
                    } else {
                        let cookie = cookieStore.get("webauthn-proxy-username");
                        const cookieValue = () => {
                            cookie.then((a) => {
                                $('#username').val(a.value);
                                $('#registerLink').click(registerLinkClick.bind(registerLinkClick, a.value));
                            })
                            .catch(error => {})
                        };
                        cookieValue();
                    }

                    // Set focus to the username field
                    $('#username').focus();

                    // Click handler for the "register" link
                    $('#registerLink').click(registerLinkClick.bind(registerLinkClick, username));
                }
            });
        </script>
    </head>
    <body>
        <div id="form">
            <img src="/webauthn/static/title-image.png" />
            <div id="errorMessages" class="errorMessageText"></div>
            <div id="successMessages" class="successMessageText"></div>
            <br />
            <table>
                <tr>
                    <td>Authenticate:</td>
                    <td><input type="text" name="username" id="username" size="30" /></td>
                    <td><button id="loginButton">Login</button></td>
                </tr>
            </table>
            <br />
            New User? <a id="registerLink">Register</a>
        </div>
    </body>
</html>
